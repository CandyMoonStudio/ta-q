# レビュー永続化機能 事前計画書

本ドキュメントは、ta-q（GitHub Pages）におけるレビュー機能（OK/NG/DEBUG振り分け）の実装に向けた設計方針をまとめたものである。

## 1. 問題IDの安定性戦略

* **現状**: `questions_edit.tsv` の `id` カラムは現在重複がなく一意である（2026/01/17 確認済み）。
* **方針**: **IDをそのまま主キーとして利用する**
  * 重複がないため、複雑な複合キー（ファイル名+ID等）は不要。
  * **運用ルール**: 今後問題を追加・編集する際は、必ずIDの重複がないことを確認する（CIまたはビルドスクリプトで重複チェックを自動化することを推奨）。

## 2. 状態（status）定義

各問題に対して、以下の4つの状態を付与できる仕様とする。

| Status | 意味 | 運用ルール | 備考 |
| :--- | :--- | :--- | :--- |
| **ok** | 採用 (Adopt) | 公開版(prod)に含める | |
| **ng** | 不採用 (Reject) | 削除または修正が必要 | |
| **debug** | 要修正 (Debug) | バグや表記揺れなど、修正して採用を目指す | |
| **hold** | 保留 (Hold) | 判断がつかない、後で直す | デフォルト未判定とは区別する |

* **未判定**: `localStorage` にレコードが存在しない状態。
* **遷移ルール**: 任意のステータスから任意のステータスへ変更可能（例：NG → OK への復活も可）。
* **更新日時**: ステータスまたはメモが変更されるたびに `updatedAt` を現在時刻で更新する。

## 3. 永続化データ（localStorage）仕様

ブラウザの `localStorage` を使用してレビュー結果を保存する。

* **Key Name**: `taq_review_v2`
  * `v2` を付与し、将来のスキーマ変更時の衝突を防ぐ。
* **Schema**:

    ```typescript
    type ReviewStatus = 'ok' | 'ng' | 'debug' | 'hold';

    interface ReviewData {
      [id: string]: {
        status: ReviewStatus;
        note?: string;      // 任意：コメント
        updatedAt: number;  // Univ Time (ms)
      }
    }
    ```

* **エラーハンドリング**:
  * JSONパース失敗時や破損時は、可能であれば復旧を試みるが、基本は空オブジェクト `{}` にフォールバックしてUIエラーを防ぐ（コンソールに警告を出力）。

## 4. エクスポート形式（NG/DEBUG）

GitHub Issue や Pull Request に貼り付けやすい **Markdown形式** を採用する。

### フォーマット例

```markdown
## NG List (3 items)
- **[ng-01]** 将棋の駒で一番強いのは？
  - Reason: 定義が曖昧
- **[42]** 「雨」が雪に変わる温度は（摂氏）？
  - Reason: 括弧が含まれている

## DEBUG List (1 item)
- **[25]** 2月は通常何日まで？
  - Note: うるう年の扱いを追記すべきか検討
```

* **出力項目**:
  * 必須: `id` (バッジ表記 `[id]` 推奨), `note` (Reason/Noteとして表示)
  * 推奨: `question` (冒頭部分)
* **並び順**: `updatedAt` の降順（直近で作業したものが上に来るように）。
* **フォールバック**: `navigator.clipboard.writeText` が失敗した場合は、画面上に `<textarea>` を表示して手動コピーさせる。

## 5. ロールバック/無効化戦略

公開環境（GitHub Pages）でのトラブル即応のため、安全弁を設ける。

* **Feature Flag**: グローバル定数（例: `window.TAQ_REVIEW_ENABLED`）またはURLパラメータ（`?review=1`）で制御する設計とする。
  * 初期リリース時は `true` でよいが、緊急停止が必要な場合はコード修正で `false` に切り替え、UI要素（ボタン等）を非表示にする。
* **データ保護**: UIを無効化しても `localStorage` のデータは削除しない（`clear()` は呼ばない）。

## 6. NOT NOW（今回はやらないこと）

* **端末間同期**: Firebase/Gist等を使ったクラウド同期はスコープ外。
* **自動書き換え**: リポジトリのTSV/JSONをブラウザから直接書き換える機能（FS Access API等）は実装しない。
* **認証機構**: ログイン機能は設けない（あくまで個人用ツール）。
